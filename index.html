<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Submit Ticket</title>
<style>
  :root { --ink:#e5e7eb; --muted:#94a3b8; --card:#0b1324; --line:#1f2937; --bg:#0b1220; --accent:#22c55e; }
  *{box-sizing:border-box} body{margin:0;font:16px/1.4 system-ui,Segoe UI,Roboto;background:var(--bg);color:var(--ink)}
  .wrap{max-width:820px;margin:40px auto;padding:20px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:22px;box-shadow:0 6px 30px rgba(0,0,0,.25)}
  h1{margin:0 0 14px} label{display:block;margin:14px 0 6px}
  input,select,textarea{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #374151;background:#0b1324;color:var(--ink)}
  textarea{min-height:120px;resize:vertical}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .actions{display:flex;gap:10px;margin-top:16px;align-items:center;flex-wrap:wrap}
  button{border:0;border-radius:10px;padding:12px 16px;font-weight:600;cursor:pointer;background:var(--accent);color:#021}
  button.secondary{background:#334155;color:#e5e7eb}
  .toast{margin-top:12px;padding:10px;border-radius:10px;background:#052e1a;color:#d1fae5;display:none}
  .err{margin-top:12px;padding:10px;border-radius:10px;background:#3b1d1d;color:#fecaca;display:none}
  a{color:#93c5fd} .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Maintenance / Repair Ticket</h1>
    <p class="muted">When deployed to Vercel, open <b>https://your-app.vercel.app/index.html</b></p>

    <form id="ticketForm" autocomplete="off">
      <label for="reqName">Name of Requester *</label>
      <input id="reqName" required />

      <div class="row">
        <div>
          <label for="dept">Department *</label>
          <input id="dept" required list="deptList" placeholder="e.g., IT, Facilities, Registrar" />
          <datalist id="deptList">
            <option>IT</option><option>Facilities</option><option>Registrar</option>
            <option>Finance</option><option>Library</option><option>HR</option>
          </datalist>
        </div>
        <div>
          <label for="urgency">Urgency *</label>
          <select id="urgency" required>
            <option value="" disabled selected>Select urgency</option>
            <option>Low</option><option>Normal</option><option>High</option><option>Critical</option>
          </select>
        </div>
      </div>

      <label for="desc">Description of Issue *</label>
      <textarea id="desc" required placeholder="Location, equipment, symptoms, when it started…"></textarea>

      <div class="actions">
        <button type="submit">Submit Ticket</button>
        <button type="reset" class="secondary">Clear</button>
        <span class="muted">Admin: <a href="/admin.html">Open Panel</a></span>
      </div>
      <div id="toast" class="toast">Ticket submitted! Reference: <b id="ref"></b></div>
      <div id="err" class="err"></div>
    </form>
  </div>
</div>

<script>
async function quickHealth(){
  try{
    const r = await fetch('/api/health');
    if(!r.ok) throw new Error('HTTP '+r.status);
  }catch(e){
    const box = document.getElementById('err');
    box.textContent = 'API not reachable. If running locally, use `vercel dev` or `npm run dev` (see README).';
    box.style.display = 'block';
  }
}
quickHealth();

function shortId(){
  const d = new Date();
  const y = String(d.getFullYear()).slice(-2);
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  const h = String(d.getHours()).padStart(2,'0');
  const min = String(d.getMinutes()).padStart(2,'0');
  return `${y}${m}${day}${h}${min}-` + Math.random().toString(36).slice(2,6).toUpperCase();
}
document.getElementById('ticketForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const payload = {
    ticketId: shortId(),
    createdAt: new Date().toISOString(),
    requester: document.getElementById('reqName').value.trim(),
    department: document.getElementById('dept').value.trim(),
    description: document.getElementById('desc').value.trim(),
    urgency: document.getElementById('urgency').value,
    status: 'Open',
    completedAt: null
  };
  const errBox = document.getElementById('err');
  errBox.style.display='none';
  try {
    const r = await fetch('/api/tickets', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!r.ok){
      let details='';
      try{ const jj = await r.json(); details = jj.error ? ' — '+jj.error : ''; }catch{}
      throw new Error(r.status+' '+r.statusText+details);
    }
    document.getElementById('ref').textContent = payload.ticketId;
    document.getElementById('toast').style.display = 'block';
    e.target.reset(); document.getElementById('reqName').focus();
  } catch(err){
    errBox.textContent = 'Submit failed: ' + err.message + ' (Is the API deployed? Is MONGODB_URI set in Vercel?)';
    errBox.style.display = 'block';
  }
});
</script>
</body>
</html>
